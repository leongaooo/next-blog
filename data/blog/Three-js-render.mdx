---
title: ğŸ§  ä¸‰åˆ†è§†ç•Œï¼šThree.js ç¦»å±æ¸²æŸ“ä¸å¤šé‡è§†è§’çš„è‰ºæœ¯
date: '2025-07-28'
tags: ['three-js']
draft: false
summary: Off-screen rendering, optimization genius
---

_ä½œè€…ï¼šä¸€åæ›¾åœ¨å¸§ç¼“å­˜æ·±æ¸Šé‡Œæ‘¸çˆ¬æ»šæ‰“çš„åƒç´ ç‚¼é‡‘æœ¯å£«_

---

## ğŸ¿ åºç« ï¼šä¸»å±ä¹‹å¤–ï¼Œå¦æœ‰æ´å¤©

åœ¨ Three.js çš„ä¸–ç•Œé‡Œï¼Œ**æ¸²æŸ“å™¨**æ˜¯é‚£ä½è´Ÿè´£æŠŠ 3D å¹»è±¡çŒæ³¨åˆ°ä½ çœ¼çƒé‡Œçš„é­”æœ¯å¸ˆã€‚è€Œé»˜è®¤çš„ `WebGLRenderer` æ¯æ¬¡éƒ½æ˜¯å¿ å®åœ°å°†å›¾åƒæ¸²æŸ“åˆ°å±å¹•çš„ç”»å¸ƒä¸Šï¼Œåƒä¸€ä½å®ˆæ—§çš„æˆå‰§æ¼”å‘˜ï¼Œæ€»æ¼”åŒä¸€å‡ºå¥½æˆã€‚

ä½†å¦‚æœæˆ‘å‘Šè¯‰ä½ â€”â€”æˆ‘ä»¬å¯ä»¥å·å¤©æ¢æ—¥ï¼Œå·å·æŠŠåœºæ™¯æ¸²æŸ“åˆ°ä¸€å—çœ‹ä¸è§çš„å¸ƒä¸Šï¼ˆä¹Ÿå°±æ˜¯ **ç¦»å±æ¸²æŸ“**ï¼‰ï¼Œç„¶åå†åƒé­”æœ¯è´´ç”»ä¸€æ ·ï¼ŒæŠŠè¿™å—å¸ƒæ‹¼æ¥å‡ºæ›´ç»šçƒ‚çš„è§†è§‰å®‡å®™å‘¢ï¼Ÿ

æ˜¯çš„ï¼Œè¿™ä¸€åˆ‡ï¼Œéƒ½è¦ä» `WebGLRenderTarget` è¯´èµ·ã€‚

---

## ğŸ¨ ç¬¬ä¸€å¹•ï¼šRenderTarget çš„ç¥ç§˜èº«ä¸–

åœ¨ WebGL ä¸­ï¼Œæ¯ä¸€å¸§çš„ç»˜åˆ¶éƒ½ä¼šå†™å…¥ä¸€ä¸ªå«åš **å¸§ç¼“å†²ï¼ˆFramebufferï¼‰** çš„é­”æ³•ç›’ã€‚è€Œ `RenderTarget` å°±æ˜¯æˆ‘ä»¬åœ¨ Three.js ä¸­å¯¹å¸§ç¼“å†²çš„ä¸€æ¬¡â€œé«˜é›…å°è£…â€ã€‚

```
const renderTarget = new THREE.WebGLRenderTarget(
  window.innerWidth,
  window.innerHeight,
  {
    minFilter: THREE.LinearFilter,
    magFilter: THREE.LinearFilter,
    format: THREE.RGBAFormat,
  }
);
```

è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿçš„ç”»å¸ƒï¼Œä¸€å—éšå½¢çš„ç”»å·ï¼Œæ‰€æœ‰ä½ æ¸²æŸ“è¿›å»çš„å›¾åƒéƒ½ä¼šè¢«ç”»åœ¨è¿™é‡Œï¼Œè€Œéå±å¹•ä¸Šã€‚æˆ‘ä»¬å¯ä»¥ï¼š

- ç”¨å®ƒç»˜åˆ¶é˜´å½±è´´å›¾
- åšç¯å¢ƒåå°„
- å®ç°åå¤„ç†ï¼ˆåæœŸè°ƒè‰²ã€æ¨¡ç³Šã€è¾‰å…‰ç‰¹æ•ˆç­‰ï¼‰
- è¿›è¡Œå¤š Pass æ¸²æŸ“ï¼ˆå¥½æˆè¿˜åœ¨åå¤´ï¼‰

---

## ğŸ§­ ç¬¬äºŒå¹•ï¼šç¦»å±æ¸²æŸ“çš„ä¸‰æ¿æ–§

### ğŸª1. å¤šé‡è§†è§’ï¼ˆå¤šç›¸æœºï¼‰

æƒ³è±¡ä½ åœ¨æ‹ä¸€éƒ¨ 3D ç”µå½±ï¼Œä¸€å°ç›¸æœºæ‹ä¸»è§†è§’ï¼Œå¦ä¸€å°æ‹åå…‰é•œä¸­çš„ä½ ã€‚è¿™è¯¥æ€ä¹ˆå®ç°ï¼Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªç›¸æœºå‡†å¤‡ä¸€ä¸ªè‡ªå·±çš„æ¸²æŸ“ç›®æ ‡ã€‚

```
const camera1 = new THREE.PerspectiveCamera();
const camera2 = new THREE.PerspectiveCamera();

const rt1 = new THREE.WebGLRenderTarget(w, h);
const rt2 = new THREE.WebGLRenderTarget(w, h);

renderer.setRenderTarget(rt1);
renderer.render(scene, camera1);

renderer.setRenderTarget(rt2);
renderer.render(scene, camera2);

// å›åˆ°ä¸»å±å¹•
renderer.setRenderTarget(null);
```

æ­¤æ—¶ï¼Œä½ æ‰‹é‡Œå°±æ‹¥æœ‰äº†ä¸¤ä¸ªä¸åŒè§’åº¦çš„ä¸–ç•Œå¿«ç…§ï¼Œå¯ä»¥æŠŠå®ƒä»¬è´´åœ¨åœºæ™¯çš„ä»»ä½•æè´¨ä¸Šï¼Œå®ç°â€œä¸Šå¸è§†è§’â€ã€â€œé•œä¸­ä¸–ç•Œâ€ã€â€œåè§†é•œâ€ç­‰è§†æ•ˆã€‚

---

### ğŸ”®2. å¤š Pass æ¸²æŸ“ï¼ˆå±‚å±‚é€’è¿›çš„ç‚¼é‡‘æœ¯ï¼‰

å•æ¬¡æ¸²æŸ“å¤ªå¯¡æ·¡ï¼Ÿé‚£å°±åˆ†å¤šä¸ª Passï¼Œè®©æ¯ä¸€æ­¥éƒ½å˜å¾—é­”æ€§ï¼š

#### ç¬¬ä¸€æ­¥ï¼šæ¸²æŸ“åŸºç¡€è‰²ï¼ˆAlbedoï¼‰

```
renderer.setRenderTarget(rtColor);
renderer.render(colorScene, camera);
```

#### ç¬¬äºŒæ­¥ï¼šè®¡ç®—å…‰ç…§æˆ–è¾¹ç¼˜é«˜äº®

```
renderer.setRenderTarget(rtLighting);
renderer.render(lightingScene, camera);
```

#### ç¬¬ä¸‰æ­¥ï¼šå°†å®ƒä»¬åˆå¹¶è¾“å‡º

æœ€ç»ˆæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå±å¹•ç©ºé—´çš„æ­£æ–¹å½¢ï¼ˆ`THREE.PlaneGeometry`ï¼‰+ è‡ªå®šä¹‰ Shaderï¼Œå°†ä¹‹å‰çš„ç»“æœæ··åˆè¾“å‡ºï¼š

```
fullScreenQuad.material = new THREE.ShaderMaterial({
  uniforms: {
    tColor: { value: rtColor.texture },
    tLighting: { value: rtLighting.texture },
  },
  vertexShader: `...`,
  fragmentShader: `
    uniform sampler2D tColor;
    uniform sampler2D tLighting;
    void main() {
      vec4 base = texture2D(tColor, gl_FragCoord.xy / resolution);
      vec4 light = texture2D(tLighting, gl_FragCoord.xy / resolution);
      gl_FragColor = base + light; // ç®€å•å åŠ 
    }
  `,
});
renderer.setRenderTarget(null);
renderer.render(screenScene, camera);
```

ğŸ¬ è¿™æ ·ä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ª**å›¾å±‚åŒ–çš„æ¸²æŸ“æµç¨‹**ï¼Œæ¯ä¸€ä¸ª Pass éƒ½æ˜¯ä¸€æ¬¡è§†è§‰ç‚¼é‡‘ï¼Œå¯ä»¥åšæ¨¡ç³Šã€è¾‰å…‰ã€è‰²å½©åˆ†ç¦»ã€æè¾¹ã€GBuffer ç­‰é«˜çº§æ•ˆæœã€‚

---

### ğŸ§ª3. ä½¿ç”¨å¤šä¸ª RenderTarget åŒæ—¶è¾“å‡ºå¤šå¼ è´´å›¾ï¼ˆMRTï¼‰

éœ€è¦ GBuffer å—ï¼Ÿéœ€è¦ä¸€æ¬¡æ€§è¾“å‡ºæ³•çº¿å›¾ã€æ·±åº¦å›¾å’Œé¢œè‰²å›¾ï¼Ÿå¯ç”¨ **MRTï¼ˆMultiple Render Targetsï¼‰** æ¨¡å¼ï¼

> âš ï¸ å‰ææ˜¯æµè§ˆå™¨æ”¯æŒ `WEBGL_draw_buffers` æ‰©å±•ï¼ˆå¤§å¤šæ•°æ”¯æŒï¼‰

```
const rt = new THREE.WebGLMultipleRenderTargets(w, h, 3);
rt.texture[0].name = 'Color';
rt.texture[1].name = 'Normal';
rt.texture[2].name = 'Position';

// åœ¨ Shader ä¸­ä½¿ç”¨ gl_FragData[i] è¾“å‡ºä¸åŒçº¹ç†
```

ä½ å°±å¯ä»¥ä¸€æ¬¡æ€§ç»˜åˆ¶å‡ºä¸‰å¼ çº¹ç†è´´å›¾ï¼Œç„¶åå†åšä½ æƒ³åšçš„åå¤„ç†ã€‚

---

## ğŸ“¦ ç¬¬ä¸‰å¹•ï¼šè‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Ÿè¿˜æ˜¯è¯´è‡ªå®šä¹‰ç®¡çº¿ï¼Ÿ

è™½ç„¶ `WebGLRenderer` å·²ç»åšå¾—å¾ˆä¸é”™ï¼Œä½†å¦‚æœä½ æƒ³æ‹¥æœ‰æ›´ç»†èŠ‚çš„æ§åˆ¶ï¼ˆæ¯”å¦‚å®Œå…¨æ‰‹åŠ¨æ§åˆ¶æ¸²æŸ“é¡ºåºï¼‰ï¼Œå¯ä»¥è€ƒè™‘ï¼š

- å†™ä¸€ä¸ªæ¸²æŸ“è°ƒåº¦å™¨ï¼ˆRender Graphï¼‰
- ä½¿ç”¨ä½é˜¶ WebGL API å®ç°æ›´åº•å±‚çš„æ¸²æŸ“é€»è¾‘
- æˆ–è€…â€¦â€¦ç›´æ¥æ”¹å†™ Three.js çš„ `WebGLRenderer.prototype.render` æ–¹æ³•ï¼ˆé­”æ³•æ…ç”¨ï¼‰

ä¾‹å¦‚æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸ªå®Œæ•´çš„å¤š Pass æ¸²æŸ“ï¼š

```
function render() {
  renderer.setRenderTarget(rt1);
  renderer.clear();
  renderer.render(scene1, camera1);

  renderer.setRenderTarget(rt2);
  renderer.clear();
  renderer.render(scene2, camera2);

  // æœ€ååˆæˆ
  renderer.setRenderTarget(null);
  renderer.render(finalScene, finalCamera);
}
```

è¿™å°±åƒä½ æˆä¸ºäº†æ•´åœºç”µå½±çš„å¯¼æ¼”ï¼Œä¸å†åªæ˜¯è§‚ä¼—ã€‚

---

## ğŸ§  é™„åŠ å½©è›‹ï¼šRenderTarget çš„å¸¸è§ç”¨é€”æ¸…å•

| ç”¨é€”         | æè¿°                   |
| ------------ | ---------------------- |
| åæœŸç‰¹æ•ˆ     | æ™¯æ·±ã€æ¨¡ç³Šã€æ³›å…‰ã€è‰²å·® |
| å¤šè§†è§’åˆæˆ   | å®‰å…¨ç›‘æ§ã€ä¸Šå¸è§†è§’     |
| å…‰ç…§è´´å›¾     | åŠ¨æ€é˜´å½±ã€çƒ˜ç„™åå°„     |
| GBuffer      | å»¶è¿Ÿæ¸²æŸ“å‡†å¤‡           |
| é•œé¢åå°„     | åå°„æ¢å¤´ã€ç»ç’ƒçƒåå°„   |
| ç¼“å­˜å¤æ‚æ¸²æŸ“ | èŠ‚çœ GPU æ€§èƒ½          |

---

## ğŸ§™ å°¾å£°ï¼šåƒç´ ç‚¼é‡‘æœ¯å£«çš„å˜±å’

æ¯ä¸€æ¬¡ `renderTarget` çš„ä½¿ç”¨ï¼Œéƒ½æ˜¯å¯¹ GPU ç©ºé—´ä¸æ˜¾å­˜çš„æŒ‘æˆ˜ï¼›æ¯ä¸€æ¬¡å¤š Pass çš„æ¸²æŸ“ï¼Œéƒ½æ˜¯æ€§èƒ½ä¸ç”»è´¨çš„å–èˆã€‚å› æ­¤è¯·ä½ ï¼š

- è®°å¾—é‡Šæ”¾ä¸å†ä½¿ç”¨çš„ RenderTargetï¼ˆ`.dispose()`ï¼‰
- ç†æ€§ä½¿ç”¨å¤š Passï¼Œé¿å…è¿‡åº¦æ¸²æŸ“
- ä¸ºä½ çš„ç¦»å±å®‡å®™èµ·ä¸€ä¸ªæµªæ¼«çš„åå­— ğŸŒŒ

---

## ğŸ“š æ¨èå»¶ä¼¸é˜…è¯»

- [Three.js æ–‡æ¡£ä¸­çš„ RenderTarget ç« èŠ‚](https://threejs.org/docs/#api/en/renderers/WebGLRenderTarget)
- [PostProcessing Framework in Three.js](https://github.com/mrdoob/three.js/blob/master/examples/jsm/postprocessing/)
- WebGL Shading Languageï¼ˆGLSLï¼‰åŸºç¡€

---

æ„¿ä½ åœ¨è™šæ‹Ÿç”»å¸ƒä¸­ï¼Œç»˜å‡ºä¸‡åƒçœŸå®ã€‚

â€”â€”**åƒç´ çš„ä»†äººï¼Œå…‰çš„ä½¿è€…ï¼ŒThree.js å¼€å‘è€…** ğŸ’¡
